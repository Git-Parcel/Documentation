# Minium Viable Product

## v0

将Parcel划分成若干个长方体子区，所有子区共享调色板。

子区的划分方式满足以下要求：

- 其中每个子区的大小不超过 $16^3 = 4096$
- 每个子区的坐标都是相对于parcel的最小顶点的偏移量，始终非负

每个子区对应一个纯文本文件

### 目录结构

- `blocks/` 方块和方块实体
  - `palette.txt` 调色板
  - `nbt/`
    - `<id>.snbt` 以调色板ID命名的 SNBT 文件，格式化，用`\t`缩进
  - `subparcels/*` 子区
- `entities/*` 实体

子区的路径：

1. 根据parcel的长宽高，将子区的xyz坐标映射到一维索引
2. 对于每一个子区，计算其一维索引，并转换成16进制字符串（大写），并在前面补0以确保所有子区的索引字符串长度相等，且长度是偶数，例如0000, 0001, 0002, ... 0A00, 0A01等
   1. 每个子区对应的文件名（不含父目录路径）是`<索引字符串>.txt`
   2. 子区的路径是将其索引字符串从开头开始，每2位作为一层目录，例如：`01.txt`, `01/0102.txt`, `01/02/010203.txt`, `01/02/03/01020304.txt`

### 调色板格式

每行一个，以16进制索引开头，后跟一个`=`，再跟着方块ID，然后是可选的方块状态

示例：

- `0=minecraft:air`
- `1=minecraft:stone`
- `2=minecraft:grass_block[facing=north]`

有些方块有额外的NBT数据，这些数据会被保存到 `nbt/` 目录下的文件中

### 子区格式

- 按行存储
- 行分隔符是LF
- 行与子区中的方块一一对应
- 行的内容是调色板索引的16进制表示
- 保存时不必在末尾添加换行符

示例：一个2x2x2的子区：

```
0
1
A
13
2
F
A
B
```

### 实体格式

## v1

其余与 v0 相同，唯独子区格式不同。

将连续相同调色板索引的方块合并为长方体微区，用一行表示多个方块，提高压缩率。

行的格式：

```
<fromX><fromY><fromZ>[<toX><toY><toZ>]=<paletteIndex>
```

|                | 长度 |                                |
| -------------- | ---- | ------------------------------ |
| `fromX`        | 1    | 起始X坐标 (0-F)                |
| `fromY`        | 1    | 起始Y坐标 (0-F)                |
| `fromZ`        | 1    | 起始Z坐标 (0-F)                |
| `toX`          | 1    | 结束X坐标 (0-F)                |
| `toY`          | 1    | 结束Y坐标 (0-F)                |
| `toZ`          | 1    | 结束Z坐标 (0-F)                |
| `=`            | 1    | 分隔符                         |
| `paletteIndex` |      | 调色板索引（16进制，无前导零） |
| 其中：         |      |                                |

- `from` 小于 `to`
- 是闭区间，`from`也被视为微区的一部分

示例：

```
0A9=F
0A9F09=0
005FF5=3
000FFF=1
```

因为子区的三个维度的大小上限都是16，所以每个维度用一个16进制字符即可表示方块在其中的坐标。

- 符号 `=`左边为6个字符的表示一个微区，其中的方块具有相同的调色板索引
- 符号 `=` 左边为3个字符的表示这个
- 如果一个微区的大小是1，则省略`to`
- 调色板索引用16进制表示，不定长度
- 不记录空气方块

微区生成算法需要满足以下要求：

- 确定性：相同内容生成相同输出
- 最大化合并：尽可能合并成大长方体
- 顺序稳定：行按固定顺序排列
